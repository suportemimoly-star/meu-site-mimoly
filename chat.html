<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimoly - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/styles.css">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; }
        .chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1.5rem; word-wrap: break-word; }
        .my-message { margin-left: auto; color: white; border-bottom-right-radius: 0.5rem; }
        .other-message { margin-right: auto; background-color: #374151; border-bottom-left-radius: 0.5rem; }
        .system-message { text-align: center; width: 100%; padding: 0.5rem 1rem; font-size: 0.8rem; color: #6b7280; font-style: italic; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">

    <header id="chat-header" class="fixed top-0 left-0 right-0 z-20 bg-black backdrop-blur-sm shadow-lg w-full"></header>

    <main id="chat-messages" class="overflow-y-auto pt-20 pb-24 flex-grow" style="height: calc(100vh - 120px);">
        <div id="loading-chat" class="text-center py-10 text-gray-400"> Carregando conversa... </div>
        <div id="loading-spinner" class="w-full py-4 justify-center items-center hidden">
    <svg class="animate-spin h-6 w-6 text-pink-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
</div>
        <div id="messages-container" class="space-y-4 px-4"></div>
    </main>

   <form id="message-form" class="fixed bottom-0 left-0 right-0 z-20 bg-gray-800 p-3 border-t border-gray-700 flex items-center space-x-3">
    <input type="text" id="message-input" placeholder="Digite sua mensagem..." class="flex-grow bg-gray-700 border border-gray-600 rounded-full py-2 px-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-pink-500 min-w-0">
    <button type="submit" id="send-message-btn" class="bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white font-bold p-3 rounded-full transition-all duration-300 hover:shadow-lg hover:shadow-pink-500/50 flex items-center justify-center">
        <i data-lucide="send" class="w-5 h-5"></i>
    </button>
</form>

    <div id="terms-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full flex flex-col" style="height: 80vh;">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Termos de Serviço</h2>
                <button id="close-terms-modal" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 text-gray-300 overflow-y-auto space-y-4">
                <p><strong>Última atualização:</strong> 12 de setembro de 2025</p>
                <p>Bem-vindo(a) à Mimoly! Estes Termos de Serviço ("Termos") governam o seu acesso e uso da plataforma Mimoly, incluindo nosso site, aplicativos e serviços relacionados (coletivamente, a "Plataforma"). Ao criar uma conta ou utilizar nossa Plataforma, você concorda em cumprir e se vincular a estes Termos. Por favor, leia-os com atenção.</p>
                <h3 class="text-lg font-semibold text-white pt-4">1. ACEITAÇÃO DOS TERMOS</h3>
                <p>Ao acessar ou usar a Plataforma, você confirma que leu, entendeu e concorda em estar legalmente vinculado a estes Termos e à nossa Política de Privacidade. Se você não concorda com estes Termos, não deve acessar ou usar a Plataforma.</p>
                <h3 class="text-lg font-semibold text-white pt-4">2. ELEGIBILIDADE</h3>
                <p>Para criar uma conta e utilizar os services da Mimoly, você deve atender aos seguintes critérios:</p>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Ter no mínimo 18 anos de idade. A Plataforma não se destina a menores de idade.</li>
                    <li>Não ter sido condenado(a) por crime de natureza sexual ou violenta.</li>
                    <li>Não ter sido previamente banido(a) da Plataforma por violação dos nossos Termos.</li>
                </ul>
                <p>Ao criar uma conta, você declara e garante que cumpre todos os requisitos de elegibilidade.</p>
                <h3 class="text-lg font-semibold text-white pt-4">3. DEFINIÇÕES PRINCIPAIS</h3>
                <p><strong>"Mimos":</strong> São os créditos virtuais adquiridos pelos usuários na Loja da Plataforma. Os Mimos são necessários para iniciar conversas com outros usuários.</p>
                <p><strong>"Carteira" / "Saldo em Reais":</strong> Representa o valor monetário acumulado por um usuário ao receber e responder a uma primeira mensagem de um chat que não seja gratuito.</p>
                <p><strong>"Valor de Repasse":</strong> É o percentual do valor de um "Mimo" que é convertido em "Saldo em Reais" e creditado na carteira do usuário que responde à conversa.</p>
                <h3 class="text-lg font-semibold text-white pt-4">4. FUNCIONAMENTO DA PLATAFORMA</h3>
                <h4 class="text-md font-semibold text-gray-200 pt-2">4.1. Compra e Uso de Mimos</h4>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Para iniciar uma conversa com outro usuário, o usuário iniciador deve possuir e utilizar um "Mimo", a menos que se qualifique para uma conversa gratuita promocional.</li>
                    <li>Os "Mimos" são adquiridos através da Loja da Plataforma, mediante pagamento.</li>
                    <li>Os "Mimos" são uma licença de uso limitado para funcionalidades da Plataforma. Eles não possuem valor monetário fora da Plataforma, não são passíveis de reembolso, e não podem ser trocados ou vendidos entre usuários.</li>
                    <li>O valor Repassado em carteira pode variar conforme descontos e novos planos, determinados pela plataforma sem aviso prévio.</li>
                </ul>
                <h4 class="text-md font-semibold text-gray-200 pt-2">4.2. Acúmulo de Saldo em Reais</h4>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Um usuário acumula "Saldo em Reais" em sua carteira quando responde a uma mensagem inicial de um chat pago (que consumiu um "Mimo" do remetente).</li>
                    <li>O valor creditado corresponde ao "Valor de Repasse", que é 50% do valor do Mimo, já deduzido de taxas e impostos.</li>
                    <li>Nenhum valor será creditado por respostas em chats gratuitos ou por mensagens subsequentes na mesma conversa, a menos que a conversa seja reativada com um novo Mimo.</li>
                </ul>
                <h3 class="text-lg font-semibold text-white pt-4">5. POLÍTICA DE SAQUES</h3>
                <h4 class="text-md font-semibold text-gray-200 pt-2">5.1. Condições para Saque</h4>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>O usuário poderá solicitar o saque do seu "Saldo em Reais" acumulado somente quando o valor atingir o montante mínimo de R$ 5,00 (cinco reais).</li>
                    <li>Valores inferiores a R$ 5,00 não são elegíveis para saque e permanecerão na carteira do usuário.</li>
                </ul>
                <h4 class="text-md font-semibold text-gray-200 pt-2">5.2. Processo de Saque</h4>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Os saques são processados via PIX. O usuário é o único responsável por fornecer uma chave PIX correta e válida em seu perfil.</li>
                    <li>A Plataforma não se responsabiliza por transferências enviadas para chaves PIX incorretas informadas pelo usuário.</li>
                    <li>O prazo para processamento do saque será informado no momento da solicitação.</li>
                </ul>
                <h3 class="text-lg font-semibold text-white pt-4">6. CONDUTA DO USUÁRIO E CONTEÚDO</h3>
                <p>Você concorda em não:</p>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>Publicar conteúdo que seja ilegal, odioso, ameaçador, difamatório, pornográfico ou que incite à violência.</li>
                    <li>Usar a Plataforma para qualquer finalidade ilegal ou fraudulenta.</li>
                    <li>Assediar, intimidar ou perseguir outros usuários.</li>
                    <li>Criar perfis falsos, se passar por outra pessoa ou fornecer informações falsas, como idade ou identidade.</li>
                    <li>Utilizar a Plataforma para fins comerciais, spam ou solicitação não autorizada.</li>
                </ul>
                <p>Reservamo-nos o direito de remover qualquer conteúdo e suspender ou excluir permanentemente contas que violem estas regras, a nosso exclusivo critério e sem aviso prévio.</p>
                <h3 class="text-lg font-semibold text-white pt-4">7. ENCERRAMENTO E EXCLUSÃO DE CONTA</h3>
                <h4 class="text-md font-semibold text-gray-200 pt-2">7.1. Exclusão pelo Usuário</h4>
                <p>Você pode solicitar a exclusão da sua conta a qualquer momento através das configurações do seu perfil.</p>
                <h4 class="text-md font-semibold text-gray-200 pt-2">7.2. Consequências da Exclusão de Conta</h4>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>A exclusão da conta é uma ação irreversível. Todos os seus dados, conversas, Mimos restantes e saldo em carteira serão permanentemente perdidos.</li>
                    <li class="font-bold text-amber-300">PERDA DE SALDO: O usuário declara ter ciência, concorda e aceita que, ao solicitar a exclusão de sua conta, qualquer "Saldo em Reais" acumulado em sua carteira que seja inferior ao valor mínimo de saque de R$ 5,00 será perdido e retido pela Plataforma. Não haverá direito a qualquer tipo de reembolso ou pagamento por valores abaixo do mínimo de saque no momento da exclusão da conta.</li>
                </ul>
                <h4 class="text-md font-semibold text-gray-200 pt-2">7.3. Suspensão ou Exclusão pela Plataforma</h4>
                <p>A Mimoly reserva-se o direito de suspender ou excluir sua conta, sem aviso prévio, caso você viole qualquer um destes Termos.</p>
                <h3 class="text-lg font-semibold text-white pt-4">8. PROPRIEDADE INTELECTUAL</h3>
                <p>Todos os direitos sobre a marca Mimoly, logos, software, textos e design da Plataforma são de propriedade exclusiva da Mimoly. O conteúdo gerado pelo usuário (fotos, bio, mensagens) permanece de propriedade do usuário, mas ao publicá-lo, você concede à Mimoly uma licença mundial, não exclusiva e isenta de royalties para hospedar, exibir, reproduzir e distribuir tal conteúdo com o único propósito de operar e prover os services da Plataforma.</p>
                <h3 class="text-lg font-semibold text-white pt-4">9. ISENÇÃO DE GARANTIAS E LIMITAÇÃO DE RESPONSABILIDADE</h3>
                <ul class="list-disc list-inside pl-4 space-y-1">
                    <li>A Plataforma é fornecida "no estado em que se encontra", sem garantias de qualquer tipo. Não garantimos que o serviço será ininterrupto, seguro ou livre de erros.</li>
                    <li>A Mimoly não realiza verificação de antecedentes criminais de seus usuários. Você é o único responsável por suas interações com outros usuários. Recomendamos cautela e bom senso.</li>
                    <li>Em nenhuma circunstância a Mimoly será responsável por quaisquer danos indiretos, incidentais ou consequenciais (incluindo perda de dados, lucros ou danos emocionais) decorrentes do uso da Plataforma.</li>
                </ul>
                <h3 class="text-lg font-semibold text-white pt-4">10. MODIFICAÇÕES NOS TERMOS</h3>
                <p>Reservamo-nos o direito de modificar estes Termos a qualquer momento. Caso haja alterações, notificaremos você através da Plataforma ou por e-mail. O uso contínuo da Plataforma após a data de vigência das alterações constituirá sua aceitação dos novos Termos.</p>
                <h3 class="text-lg font-semibold text-white pt-4">11. LEI APLICÁVEL E FORO</h3>
                <p>Estes Termos serão regidos e interpretados de acordo com as leis da República Federativa do Brasil para dirimir quaisquer controvérsias oriundas destes Termos.</p>
                <h3 class="text-lg font-semibold text-white pt-4">12. CONTATO</h3>
                <p>Em caso de dúvidas sobre estes Termos de Serviço, entre em contato conosco através do e-mail: contato@mimoly.com.br</p>
            </div>
            <div class="p-4 border-t border-gray-700 text-right">
                <button id="close-terms-modal-2" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>    
    <script>    
    </script>
<script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { doc, collection, query, onSnapshot, orderBy, getDoc, limit, startAfter, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { callMarkChatAsReadSafely, callSendMessageSafely } from './auth.js';
    import { loadHeader } from './header-loader.js';

    document.addEventListener('DOMContentLoaded', () => {
        const chatHeader = document.getElementById('chat-header');
        const loadingChat = document.getElementById('loading-chat');
        const messagesContainer = document.getElementById('messages-container');
        const chatMain = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        let currentUser = null;
        let chatId = null;
        let chatData = null; 
        let unsubscribeMessages = null;
        let lastVisibleMessageTimestamp = null;
        let firstVisibleMessageDoc = null;
        let isLoadingMore = false;
        
        const renderMessage = (msg) => {
            if (!msg || !msg.senderId) { return ''; }
            const isCurrentUserTheInitiator = chatData && chatData.initiatorId === currentUser.uid;
            if (msg.senderId === 'system_receiver' && isCurrentUserTheInitiator) return '';
            if (msg.senderId === 'system_initiator' && !isCurrentUserTheInitiator) return '';
            const messageText = msg.text || '';
            if (msg.senderId.startsWith('system_')) {
                return `<div class="text-center my-2 text-gray-400 italic text-xs">${messageText}</div>`;
            }
            const isMe = msg.senderId === currentUser.uid;
            const messageClass = isMe ? 'bg-gradient-to-r from-pink-500 to-orange-500 rounded-br-none ml-auto' : 'bg-gray-700 rounded-bl-none';
            const timestamp = msg.timestamp && typeof msg.timestamp.toDate === 'function' ? msg.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs md-max-w-md p-3 rounded-xl ${messageClass} inline-block">
                        <p class="text-white" style="word-wrap: break-word;">${messageText}</p>
                        <p class="text-xs ${isMe ? 'text-gray-200' : 'text-gray-400'} text-right mt-1">${timestamp}</p>
                    </div>
                </div>`;
        };
        
        const loadMoreMessages = async () => {
            if (!lastVisibleMessageTimestamp || isLoadingMore) return;
            
            isLoadingMore = true;
            loadingSpinner.style.display = 'flex';

            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, 
                            orderBy('timestamp', 'desc'), 
                            startAfter(lastVisibleMessageTimestamp), 
                            limit(20));
            
            const newSnapshot = await getDocs(q);
            const oldScrollHeight = chatMain.scrollHeight;
            
            if (newSnapshot.docs.length > 0) {
                const fragment = document.createDocumentFragment();
                newSnapshot.docs.forEach(doc => {
                    const messageHtml = renderMessage(doc.data()); 
                    if (messageHtml) { 
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = messageHtml;
                        fragment.prepend(tempDiv.firstChild);
                    }
                });
                messagesContainer.prepend(fragment);

                const lastDoc = newSnapshot.docs[newSnapshot.docs.length - 1];
                lastVisibleMessageTimestamp = lastDoc.data().timestamp;
            } else {
                lastVisibleMessageTimestamp = null;
            }
            
            loadingSpinner.style.display = 'none';
            const newScrollHeight = chatMain.scrollHeight;
            chatMain.scrollTop = newScrollHeight - oldScrollHeight;
            isLoadingMore = false;
        };
        
        const listenForNewMessages = () => {
            if (unsubscribeMessages) unsubscribeMessages();
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'), startAfter(firstVisibleMessageDoc));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageHtml = renderMessage(change.doc.data());
                        if (messageHtml) {
                            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                            chatMain.scrollTop = chatMain.scrollHeight;
                        }
                    }
                });
                if (!snapshot.empty) {
                    firstVisibleMessageDoc = snapshot.docs[snapshot.docs.length - 1];
                }
                callMarkChatAsReadSafely(chatId);
            });
        };

        const initializeChat = async () => {
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(20));
            const initialSnapshot = await getDocs(q);

            if (initialSnapshot.docs.length > 0) {
              const messages = [];
              initialSnapshot.forEach(doc => messages.unshift(doc.data()));
              const allMessagesHtml = messages.map(msg => renderMessage(msg)).join('');
              messagesContainer.innerHTML = allMessagesHtml;

              const lastDoc = initialSnapshot.docs[initialSnapshot.docs.length - 1];
              lastVisibleMessageTimestamp = lastDoc.data().timestamp;
              firstVisibleMessageDoc = initialSnapshot.docs[0]; 
              listenForNewMessages();
            } else {
              const messagesRef = collection(db, 'chats', chatId, 'messages');
              const q = query(messagesRef, orderBy('timestamp', 'asc'));
              unsubscribeMessages = onSnapshot(q, (snapshot) => {
                  snapshot.docChanges().forEach((change) => {
                      if (change.type === "added") {
                          const messageHtml = renderMessage(change.doc.data());
                          if (messageHtml) {
                              messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                              chatMain.scrollTop = chatMain.scrollHeight;
                          }
                      }
                  });
              });
            }
            
            if (initialSnapshot.size < 20) {
                lastVisibleMessageTimestamp = null;
            }
            
            window.requestAnimationFrame(() => chatMain.scrollTop = chatMain.scrollHeight);
            callMarkChatAsReadSafely(chatId);          
        };

        const loadChatDetails = async () => {
             try {
                const chatDoc = await getDoc(doc(db, "chats", chatId));
                if (chatDoc.exists()) {
                    chatData = chatDoc.data();
                    const otherUserId = chatData.participants.find(id => id !== currentUser.uid);
                    const otherUserDoc = await getDoc(doc(db, "users", otherUserId));
                    if (otherUserDoc.exists()) {
                         const otherUserData = otherUserDoc.data();
                         chatHeader.innerHTML = `<nav class="container mx-auto px-4 py-3 flex justify-between items-center"><a href="/conversas.html" class="text-gray-300 hover:text-white p-2"><i data-lucide="arrow-left"></i></a><a href="/profile_details.html?userId=${otherUserId}" class="flex items-center space-x-3"><img src="${otherUserData.photoURL}" alt="Foto de ${otherUserData.displayName}" class="w-10 h-10 rounded-full object-cover"><span class="font-semibold text-lg">${otherUserData.displayName}</span></a><div class="w-10"></div></nav>`;
                         lucide.createIcons();
                         loadingChat.classList.add('hidden');
                         document.querySelector('main').classList.remove('hidden');
                    }
                }
             } catch (error) {
                 console.error("Erro ao carregar detalhes do chat:", error);
                 loadingChat.innerHTML = '<p class="text-red-400">Não foi possível carregar o chat.</p>';
             }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadHeader();
                currentUser = user;
                chatId = new URLSearchParams(window.location.search).get('chatId');
                
                chatMain.addEventListener('scroll', () => {
                    if (chatMain.scrollTop === 0 && !isLoadingMore && lastVisibleMessageTimestamp) {
                        loadMoreMessages();
                    }
                });

                messageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = messageInput.value.trim();
                    if (text) {
                        const tempText = text;
                        messageInput.value = '';
                        try {
                            await callSendMessageSafely(chatId, tempText);
                        } catch (error) {
                             console.error("Erro ao enviar mensagem:", error);
                             alert(`Erro ao enviar mensagem: ${error.message}`);
                             messageInput.value = tempText;
                        }
                    }
                });
                
                await loadChatDetails();
                await initializeChat();

            } else {
                window.location.href = '/login.html';
            }
        });
    });
</script>
<script type="module" src="/header-loader.js"></script>
</body>
</html>